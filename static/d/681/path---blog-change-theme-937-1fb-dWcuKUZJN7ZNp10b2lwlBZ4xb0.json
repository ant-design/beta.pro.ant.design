{"data":{"markdownRemark":{"html":"<p>In the v4 version of pro we have added an online theme change feature. The intent of this feature is to allow designers to modify the main colors of Ant Design more quickly and preview them directly to save developers time. However, due to the immaturity of the program, many students encountered problems during the development, but could not find the problem. It was a waste of time, so we wrote this little article to explain our implementation and why it caused this problem.</p>\n<h2 id=\"background\">background<a href=\"#background\" aria-hidden class=\"anchor\">#</a></h2>\n<p>In order to simplify the use of Pro, <a href=\"https://github.com/css-modules/css-modules\"><code>css-module</code></a> is enabled, and the <code>css-module</code> is awesome in the project. Features, he can solve the problem that bothers each programmer, how to make a meaningful but not repeated css class name.</p>\n<p>But for the component css-module will increase the cost, if you want to keep less source code when publishing components, it is a more troublesome thing. First of all, even if it is not kept less. The class name of each component will change. This makes it impossible to modify the style of a component with css.</p>\n<blockquote>\n<p>Some components that don't want to be modified can use <code>css-module</code>, and each version is a new className, effectively preventing tampering.</p>\n</blockquote>\n<p>The online theme plugin is mainly implemented by compiling less in the browser. First, he finds that the project is all less and extracts the selector with fewer variables. Combine a new less, that is, the color .less, and compile it in the browser with less.js, then overwrite the original properties. It is done in the following three steps:</p>\n<h2 id=\"merge-less\">Merge less<a href=\"#merge-less\" aria-hidden class=\"anchor\">#</a></h2>\n<p>This function is mainly implemented by a plugin, <code>antd-pro-merge-less</code>, which scans all the lesss in src and merges them into a <code>./ temp / ant-deigin-pro.ess</code>. Plugins are also the most problematic plugins, causing some of the fewer references to fail.</p>\n<h2 id=\"convert-css-module\">Convert css-module<a href=\"#convert-css-module\" aria-hidden class=\"anchor\">#</a></h2>\n<p>However, as a plug-in for the theme, it is necessary to ensure that the class name is fixed, but it cannot be repeated. We did two things. First customize the class name. This can be done easily with the api<code>getLocalIdent</code> of <code>css-module</code>. This is how the pro is handled.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getLocalIdent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> localIdentName<span class=\"token punctuation\">,</span> localName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    context<span class=\"token punctuation\">.</span>resourcePath<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node_modules'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n    context<span class=\"token punctuation\">.</span>resourcePath<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ant.design.pro.less'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span>\n    <span class=\"token comment\">//umi's global.less convention does not use css-module</span>\n    context<span class=\"token punctuation\">.</span>resourcePath<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'global.less'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> localName<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// convert the uuid class name to the style of the ant-pro-file path.</span>\n  <span class=\"token comment\">// like `.antd-pro-components-global-footer-index-links`</span>\n  <span class=\"token keyword\">const</span> match <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>resourcePath<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/src(.*)/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>match <span class=\"token operator\">&amp;&amp;</span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> antdProPath <span class=\"token operator\">=</span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.less'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token function\">slash</span><span class=\"token punctuation\">(</span>antdProPath<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a</span> <span class=\"token operator\">=></span> a<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/([A-Z])/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-$1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a</span> <span class=\"token operator\">=></span> a<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token string\">`antd-pro</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>arr<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>localName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/--/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> localName<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This way, as long as the extraction is small, the class name is generated in the same way to ensure that the two are the same.</p>\n<blockquote>\n<p>Using <a href=\"https://www.npmjs.com/package/postcss-less-engine\"><code>postcss-less-engine</code></a> here, you can generate less syntax trees and modify it.</p>\n</blockquote>\n<h2 id=\"extracting-fewer-variables\">Extracting fewer variables<a href=\"#extracting-fewer-variables\" aria-hidden class=\"anchor\">#</a></h2>\n<p>This step is done by <code>antd-theme-webpack-plugin</code>. It extracts all selectors with fewer variables in the configuration by traversing fewer syntax trees and combining them into a single color.less file. <a href=\"git://github.com/mzohaibqc/antd-theme-generator\"> antd-theme-generator</a> can see the implementation.</p>\n<p>After extracting color.less, add the introduction of less in the html generated by the build through the ability of webpack. The default is</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span>\n  <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://gw.alipayobjects.com/os/lib/less.js/3.8.1/less.min.js<span class=\"token punctuation\">\"</span></span>\n<span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>stylesheet/less<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/color.less<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>When you need to change the theme, you can compile the reference by calling <code>window.less.modifyVars</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//Because the compilation time is too long and the rendering will be blocked, be sure to add a hint.</span>\nWindow<span class=\"token punctuation\">.</span>less\n  <span class=\"token punctuation\">.</span><span class=\"token function\">modifyVars</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'@ primary-color'</span><span class=\"token punctuation\">:</span> primaryColor<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Compile successfully</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Compile failed</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"existing-question\">Existing question<a href=\"#existing-question\" aria-hidden class=\"anchor\">#</a></h2>\n<p>Using the above scheme can realize the function of online theme change, but at the same time introduce some new problems. So we don't recommend using it in a production environment. Pro v4 will refine it.</p>\n<p>First of all, <code>antd-pro-merge-less</code> will cause some of the introduction of less to fail. And it is difficult to check. Compiling, merging and extracting will cause the hot update in development to slow down or become stuck. These will affect the development experience. Secondly, compiling less in the browser is not a good solution. The compilation of less will cause the main process of the browser to be stuck, and the whole page is stuck. The experience is very poor.</p>\n<p>The <code>antd-theme-webpack-plugin</code> method of extracting variables also has some problems. The compiled css does not perform well in small details. Far from being perfect in the webpack compilation.</p>\n<h2 id=\"future-improvements\">Future improvements<a href=\"#future-improvements\" aria-hidden class=\"anchor\">#</a></h2>\n<p>The current online theme is a demo, with some issues and is not suitable for adaptation in a formal environment. In v4 we will improve his performance. Start with a more elegant solution for less merging and extraction. Support for the full feature of less, which will not cause pits in development, but will reduce the impact of the development experience.</p>\n<p>The extracted variable algorithm in <code>antd-theme-webpack-plugin</code> is also optimized to speed up and is extracted after it is no longer compiled. In the formal environment, multiple css will be compiled, and the dynamic import css will be used to change the theme and be more smooth. The experience is better. At the same time, the plugins are merged, and now the three plugins are heavily coupled and do not support hot swap and downgrade scenarios.</p>","tableOfContents":"<ul>\n<li><a href=\"/blog/change-theme/#background\">background</a></li>\n<li><a href=\"/blog/change-theme/#merge-less\">Merge less</a></li>\n<li><a href=\"/blog/change-theme/#convert-css-module\">Convert css-module</a></li>\n<li><a href=\"/blog/change-theme/#extracting-fewer-variables\">Extracting fewer variables</a></li>\n<li><a href=\"/blog/change-theme/#existing-question\">Existing question</a></li>\n<li><a href=\"/blog/change-theme/#future-improvements\">Future improvements</a></li>\n</ul>","frontmatter":{"title":{"zh_CN":"Online Change Theme","en_US":"Online Change Theme"},"order":0,"type":"Blog"},"fields":{"path":"/blog/change-theme.en-US.md","slug":"/blog/change-theme","modifiedTime":1557913541568,"avatarList":[{"href":"/chenshuai2144","text":"\n        chenshuai2144\n","src":"https://avatars1.githubusercontent.com/u/8186664?s=40&amp;v=4"}]}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"title":{"zh_CN":"Pro-layout","en_US":"Pro-layout"},"order":1,"type":"Blog"},"fields":{"slug":"/blog/new-pro-use-cn","path":"/blog/new-pro-use.zh-CN.md"}}},{"node":{"frontmatter":{"title":{"zh_CN":"Pro-layout","en_US":"Pro-layout"},"order":1,"type":"Blog"},"fields":{"slug":"/blog/new-pro-use","path":"/blog/new-pro-use.en-US.md"}}},{"node":{"frontmatter":{"title":{"zh_CN":"在线换主题","en_US":"在线换主题"},"order":0,"type":"Blog"},"fields":{"slug":"/blog/change-theme-cn","path":"/blog/change-theme.zh-CN.md"}}},{"node":{"frontmatter":{"title":{"zh_CN":"Online Change Theme","en_US":"Online Change Theme"},"order":0,"type":"Blog"},"fields":{"slug":"/blog/change-theme","path":"/blog/change-theme.en-US.md"}}}]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/change-theme","type":"/blog/"}}